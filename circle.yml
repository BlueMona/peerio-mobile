machine:
  pre:
    - pip install --user --ignore-installed --upgrade --verbose virtualenv
    - ln -s ~/Library/Python/2.7/bin/virtualenv /usr/local/bin/virtualenv
  environment:
    XCODE_SCHEME: peeriomobile
    PATH: '$PATH:$HOME/node/node-v7.3.0-darwin-x64/bin'
  xcode:
    version: 8.0

dependencies:
  pre:
    - "ls \"$HOME/node/node-v7.3.0-darwin-x64\" || mkdir \"$HOME/node\""
    - "ls \"$HOME/node/node-v7.3.0-darwin-x64\" || curl -L \"https://nodejs.org/dist/v7.3.0/node-v7.3.0-darwin-x64.tar.gz\" -o \"$HOME/node/node-v7.3.0-darwin-x64.tar.gz\""
    - "ls \"$HOME/node/node-v7.3.0-darwin-x64\" || tar -xzf \"$HOME/node/node-v7.3.0-darwin-x64.tar.gz\" -C \"$HOME/node/\""
    - "rm -f \"$HOME/node/node-v7.3.0-darwin-x64.tar.gz\""
    - ls "$HOME/node/node-v7.3.0-darwin-x64"
    - echo $PATH
    - pwd
    - npm install
    - bash scripts/setup_tests.sh

compile:
  override:
    - npm update && npm install
    - ./node_modules/.bin/react-native run-ios --simulator="iPhone 7"
    
test:
  override:
    - mkdir -p $CIRCLE_TEST_REPORTS/py.test
    - virtualenv .pyenv && source .pyenv/bin/activate && PEERIO_IOS_SIM="iPhone 7" PEERIO_IOS_VERSION="10.0" py.test --platform=ios -s -x tests --junitxml=$CIRCLE_TEST_REPORTS/py.test/junit.xml
