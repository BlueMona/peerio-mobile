general:
  build_dir: ios
  
machine:
  pre:
    - pip install --user --ignore-installed --upgrade --verbose virtualenv
    - ln -s ~/Library/Python/2.7/bin/virtualenv /usr/local/bin/virtualenv
  environment:
    XCODE_SCHEME: peeriomobile
    PATH: '$PATH:$HOME/node/node-v7.3.0-darwin-x64/bin'
  xcode:
    version: 8.0

dependencies:
  pre:
    - "ls \"$HOME/node/node-v7.3.0-darwin-x64\" || mkdir \"$HOME/node\""
    - "ls \"$HOME/node/node-v7.3.0-darwin-x64\" || curl -L \"https://nodejs.org/dist/v7.3.0/node-v7.3.0-darwin-x64.tar.gz\" -o \"$HOME/node/node-v7.3.0-darwin-x64.tar.gz\""
    - "ls \"$HOME/node/node-v7.3.0-darwin-x64\" || tar -xzf \"$HOME/node/node-v7.3.0-darwin-x64.tar.gz\" -C \"$HOME/node/\""
    - "rm -f \"$HOME/node/node-v7.3.0-darwin-x64.tar.gz\""
    - "ls \"$HOME/node/node-v7.3.0-darwin-x64\""
    - "echo $PATH"
    - "pwd"

compile:
  override:
    - npm install
    - pwd && ./node_modules/.bin/react-native run-ios --simulator="iPhone 7"
    
test:
  override:
    - virtualenv .pyenv
    - source .pyenv/bin/activate
    - mkdir -p $CIRCLE_TEST_REPORTS/py.test
    - py.test --platform=ios -s -x tests --junitxml=$CIRCLE_TEST_REPORTS/py.test/junit.xml
    - deactivate
